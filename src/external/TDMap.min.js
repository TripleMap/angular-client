"use strict";var TDMap={Service:{},Layers:{},Utils:{},Routing:{}};"undefined"!=typeof window&&window.L&&(window.TDMap=TDMap),TDMap.Service.GeoJSONProvider={initialize:function(t){if(void 0===t.dataUrl&&null===t.dataUrl)throw new Error("Не задан url для GeoJSONProvider");this.options=t},getData:function(){return TDMap.Utils.Promise.getPromise(this.options.dataUrl,this.options.params,this.options.headers)},getDataByBounds:function(t){return this.options.params||(this.options.params={}),t instanceof L.LatLngBounds?this.options.params.bbox=this._getMinMaxBounds(t):this.options.params.bbox=t,this.options.styled?this.options.params.styled=this.options.styled:delete this.options.params.styled,this.options.labeled?this.options.params.labeled=this.options.labeled:delete this.options.params.labeled,TDMap.Utils.Promise.getPromise(this.options.dataUrl,this.options.params,this.options.headers)},_getMinMaxBounds:function(t){if(t){var e=t.getNorthWest(),i=t.getSouthEast();return[e.lng,i.lat,i.lng,e.lat].toString()}}},TDMap.Service.GeoJSONServiceLayer=L.GeoJSON.extend({includes:TDMap.Service.GeoJSONProvider,initialize:function(t){this.filteredIds=[],this.filterMode=!1,L.GeoJSON.prototype.initialize.call(this,null,t),TDMap.Service.GeoJSONProvider.initialize.call(this,t),L.setOptions(this,t)},setStyles:function(t){this.styles=t},removeStyles:function(){this.options.styled=!1,this.styles=!1},setLabels:function(t){this.labels=t},removeLabels:function(){this.options.labeled=!1,this.labels=!1},onAdd:function(t){this.map=t,L.GeoJSON.prototype.onAdd.call(this,t),t.on("moveend",this._updateData,this),this._updateData()},onRemove:function(t){this.clearLayers(),L.GeoJSON.prototype.onRemove.call(this,t),t.off("moveend",this._updateData,this)},_updateData:function(t){var e;e=this.options.bounds?this.options.bounds:this.options.circle?this.options.circle:this.map.getBounds();var i=this.map.getZoom();if(i>this.options.maxZoom||i<this.options.minZoom)return void this.clearLayers();this._updateDataByBounds(e,i)},_updateDataByBounds:function(t,e){var i=this;this.getDataByBounds(t).then(function(t){var e;t.data.geoJSON?e=t.data.geoJSON[0]||t.data.geoJSON:t.data.inbounds&&(e=t.data.inbounds[0]),i._replaceData(e.features)},function(t){i.clearLayers()})},styleEnebledInZoom:function(t){for(var e=this.map.getZoom(),i=this.styles.length-1;i>=0;i--)for(var a=this.styles[i].styles.length-1;a>=0;a--){if(this.styles[i].styles[a].id===t.id&&e>=this.styles[i].minZoom&&e<=this.styles[i].maxZoom)return!0;if(this.styles[i].otherStyle.id===t.id&&this.styles[i].otherStyle.allow===!0&&e>=this.styles[i].minZoom&&e<=this.styles[i].maxZoom)return!0}return!1},_replaceData:function(t){var e=this;if(null!==t&&void 0!==t){this.clearLayers();for(var i=0;i<t.length;i++)if(null!==t[i])if(this.styles){if(t[i].styles&&t[i].styles.length>0)for(var a=0;a<t[i].styles.length;a++)if(null!==t[i].styles[a]&&this.styleEnebledInZoom(t[i].styles[a])){t[i].style=t[i].styles[a];var r={};for(var n in t[i])r[n]=t[i][n];this.addData(r)}}else this.addData(t[i]);this.eachLayer(function(t){t&&e._subscribe(t),t.feature.style&&t.setStyle(t.feature.style)}),this.map.fire("layer:load"),this.filterMode&&this.stayOrRemoveViaFilteredIds(),this.updateLabels()}else this.clearLayers()},updateLabels:function(){if(this.clearLabels(),this.labels&&this.labels.length>0){var t=this.map.getZoom();t>=this.labels[0].minZoom&&t<=this.labels[0].maxZoom&&this.labelFeatures(this.labels[0])}},labelFeatures:function labelFeatures(label){function Point(t,e){this.x=t,this.y=e}function Region(t){this.points=t||[],this.length=t.length}function isNumber(t){return/^[0-9]{1,7}([,.][0-9]{1,7})?$/.test(t)}var that=this;Region.prototype.area=function(){var t,e,i,a,r=0;for(t=0,e=this.length-1;t<this.length;e=t,t++)i=this.points[t],a=this.points[e],r+=i.x*a.y,r-=i.y*a.x;return r/=2},Region.prototype.centroid=function(){var t,e,i,a,r,n=0,o=0;for(t=0,e=this.length-1;t<this.length;e=t,t++)a=this.points[t],r=this.points[e],i=a.x*r.y-r.x*a.y,n+=(a.x+r.x)*i,o+=(a.y+r.y)*i;return i=6*this.area(),new Point(n/i,o/i)},that.eachLayer(function(layer){if(layer._path&&"hidden"!==layer._path.style.visibility){var textEval=function textEval(){if("boolean"===label.workField.options.type&&"Да"!==layer.feature.properties.labelvalue&&"Нет"!==layer.feature.properties.labelvalue&&(null===layer.feature.properties.labelvalue||layer.feature.properties.labelvalue===!1?layer.feature.properties.labelvalue="Нет":layer.feature.properties.labelvalue="Да"),!label.designed)return layer.feature.properties.labelvalue;var str;str=isNumber(layer.feature.properties.labelvalue)?label.designedString.replace("{значение}",layer.feature.properties.labelvalue):label.designedString.replace("{значение}","'"+layer.feature.properties.labelvalue+"'"),label.rounded&&label.roundedNumber&&(str="("+str+").toFixed("+label.roundedNumber+")");try{return eval(str)}catch(t){throw that.fire("ERROR",{message:"Ошибка формирования строки подписи. Проверьте составную подпись"}),new Error}};layer._path.id="layer"+layer._leaflet_id;var group=d3.select(".leaflet-overlay-pane").select("svg").append("g").attr("class","labels"),region;layer._parts&&layer._parts[0]&&layer._parts[0].length>0&&(region=new Region(layer._parts[0])),d3.selectAll("#layer"+layer._leaflet_id).each(function(t,e){if(region){var i=(this.getBBox(),{x:region.centroid().x,y:region.centroid().y});0===i.x&&0===i.y||isNaN(i.x)||isNaN(i.y)||i.x!==Number.POSITIVE_INFINITY&&i.x!==Number.NEGATIVE_INFINITY&&i.y!==Number.POSITIVE_INFINITY&&i.y!==Number.NEGATIVE_INFINITY&&(group.append("text").attr("class","oreol").style("stroke",label.oreolColor).style("opacity",label.oreolOpacity).style("stroke-width",label.oreolWidth).style("font-size",label.fontSize).style("text-anchor","middle").style("font-family","Roboto,Helvetica Neue,sans-serif").attr("x",i.x).attr("y",i.y).text(textEval),group.append("text").attr("class","textpath").style("fill",label.textColor).style("fill-opacity",label.textOpacity).style("text-anchor","middle").style("font-size",label.fontSize).style("font-family","Roboto,Helvetica Neue,sans-serif").attr("x",i.x).attr("y",i.y).text(textEval))}})}})},clearLabels:function(){$(".labels").remove()},_subscribe:function(t){t&&(this.layer=t,t.on("click",this._clickFireAndForward,this))},_unSubcribeLayer:function(t){t.off("click",this._clickFireAndForward)},_clickFireAndForward:function(t){this.fire("tdmap:layer:click",t.target)},stayOrRemoveViaFilteredIds:function(){var t=this;this.eachLayer(function(e){t.filteredIds.indexOf(e.feature.properties.zu_id)===-1?e._path.style.visibility="hidden":"hidden"===e._path.style.visibility&&(e._path.style.visibility="visible")})},setFilteredIds:function(t){return this.filteredIds=t,this.filterMode=!0,this.stayOrRemoveViaFilteredIds(),this},removeFilteredIds:function(){return this.filteredIds=null,this.filterMode=!1,this._updateData(),this}}),TDMap.Service.geoJSONServiceLayer=function(t){return new TDMap.Service.GeoJSONServiceLayer(t)},L.GridLayer.GoogleMutant=L.GridLayer.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",opacity:1,continuousWorld:!1,noWrap:!1,type:"roadmap",maxNativeZoom:21},initialize:function(t){L.GridLayer.prototype.initialize.call(this,t),this._ready=!!window.google&&!!window.google.maps&&!!window.google.maps.Map,this._GAPIPromise=this._ready?Promise.resolve(window.google):new Promise(function(t,e){var i=0,a=null;a=setInterval(function(){return i>=10?(clearInterval(a),e(new Error("window.google not found after 10 attempts"))):window.google&&window.google.maps&&window.google.maps.Map?(clearInterval(a),t(window.google)):void i++},500)}),this._tileCallbacks={},this._freshTiles={},this._imagesPerTile="hybrid"===this.options.type?2:1,this.createTile="hybrid"===this.options.type?this._createMultiTile:this._createSingleTile},onAdd:function(t){L.GridLayer.prototype.onAdd.call(this,t),this._initMutantContainer(),this._GAPIPromise.then(function(){this._ready=!0,this._map=t,this._initMutant(),t.on("viewreset",this._reset,this),t.on("move",this._update,this),t.on("zoomend",this._handleZoomAnim,this),t.on("resize",this._resize,this),t._controlCorners.bottomright.style.marginBottom="20px",this._reset(),this._update()}.bind(this))},onRemove:function(t){L.GridLayer.prototype.onRemove.call(this,t),t._container.removeChild(this._mutantContainer),this._mutantContainer=void 0,t.off("viewreset",this._reset,this),t.off("move",this._update,this),t.off("zoomend",this._handleZoomAnim,this),t.off("resize",this._resize,this),t._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(t){this.options.opacity=t,t<1&&L.DomUtil.setOpacity(this._mutantContainer,t)},setElementSize:function(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px"},_initMutantContainer:function(){this._mutantContainer||(this._mutantContainer=L.DomUtil.create("div","leaflet-google-mutant leaflet-top leaflet-left"),this._mutantContainer.id="_MutantContainer_"+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.position="relative",this._mutantContainer.style.pointerEvents="none",this._map.getContainer().appendChild(this._mutantContainer)),this.setOpacity(this.options.opacity),this.setElementSize(this._mutantContainer,this._map.getSize()),this._attachObserver(this._mutantContainer)},_initMutant:function(){if(this._ready&&this._mutantContainer){this._mutantCenter=new google.maps.LatLng(0,0);var t=new google.maps.Map(this._mutantContainer,{center:this._mutantCenter,zoom:0,tilt:0,mapTypeId:this.options.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1,styles:this.options.styles||{},backgroundColor:"transparent"});this._mutant=t,this.fire("spawned",{mapObject:t})}},_attachObserver:function(t){new MutationObserver(this._onMutations.bind(this)).observe(t,{childList:!0,subtree:!0})},_onMutations:function(t){for(var e=0;e<t.length;++e)for(var i=t[e],a=0;a<i.addedNodes.length;++a){var r=i.addedNodes[a];r instanceof HTMLImageElement?this._onMutatedImage(r):r instanceof HTMLElement&&Array.prototype.forEach.call(r.querySelectorAll("img"),this._onMutatedImage.bind(this))}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+)/,_staticRegExp:/StaticMapService\.GetMapImage/,_onMutatedImage:function(t){var e,i,a,r=t.src.match(this._roadRegexp);if(r?(e={z:r[1],x:r[2],y:r[3]},this._imagesPerTile>1&&(t.style.zIndex=0),i=1):(r=t.src.match(this._satRegexp),r&&(e={x:r[1],y:r[2],z:r[3]}),i=0),e){var n=this._tileCoordsToKey(e);t.style.position="absolute",this._imagesPerTile>1&&(n+="/"+i),n in this._tileCallbacks&&this._tileCallbacks[n]?(this._tileCallbacks[n].pop()(t),this._tileCallbacks[n].length||delete this._tileCallbacks[n]):(a=t.parentNode,a&&(a.removeChild(t),a.removeChild=L.Util.falseFn),n in this._freshTiles?this._freshTiles[n].push(t):this._freshTiles[n]=[t])}else t.src.match(this._staticRegExp)&&(a=t.parentNode)&&t.parentNode.replaceChild(L.DomUtil.create("img"),t)},_createSingleTile:function(t,e){var i=this._tileCoordsToKey(t);if(i in this._freshTiles){var a=this._freshTiles[i].pop();return this._freshTiles[i].length||delete this._freshTiles[i],L.Util.requestAnimFrame(e),a}var r=L.DomUtil.create("div");return this._tileCallbacks[i]=this._tileCallbacks[i]||[],this._tileCallbacks[i].push(function(t){return function(i){var a=i.parentNode;a&&(a.removeChild(i),a.removeChild=L.Util.falseFn),t.appendChild(i),e()}.bind(this)}.bind(this)(r)),r},_createMultiTile:function(t,e){var i=this._tileCoordsToKey(t),a=L.DomUtil.create("div");a.dataset.pending=this._imagesPerTile;for(var r=0;r<this._imagesPerTile;r++){var n=i+"/"+r;n in this._freshTiles?(a.appendChild(this._freshTiles[n].pop()),this._freshTiles[n].length||delete this._freshTiles[n],a.dataset.pending--):(this._tileCallbacks[n]=this._tileCallbacks[n]||[],this._tileCallbacks[n].push(function(t){return function(i){var a=i.parentNode;a&&(a.removeChild(i),a.removeChild=L.Util.falseFn),t.appendChild(i),t.dataset.pending--,parseInt(t.dataset.pending)||e()}.bind(this)}.bind(this)(a)))}return parseInt(a.dataset.pending)||L.Util.requestAnimFrame(e),a},_checkZoomLevels:function(){void 0!==this._map.getZoom()&&this._mutant.getZoom()!==this._map.getZoom()&&this._map.setZoom(this._mutant.getZoom())},_reset:function(){this._initContainer()},_update:function(){if(L.GridLayer.prototype._update.call(this),this._mutant){var t=this._map.getCenter(),e=new google.maps.LatLng(t.lat,t.lng);this._mutant.setCenter(e);void 0!==this._map.getZoom()&&this._mutant.setZoom(Math.round(this._map.getZoom()))}},_resize:function(){var t=this._map.getSize();this._mutantContainer.style.width===t.x&&this._mutantContainer.style.height===t.y||(this.setElementSize(this._mutantContainer,t),this._mutant&&google.maps.event.trigger(this._mutant,"resize"))},_handleZoomAnim:function(){var t=this._map.getCenter(),e=new google.maps.LatLng(t.lat,t.lng);this._mutant.setCenter(e),this._mutant.setZoom(Math.round(this._map.getZoom()))},_removeTile:function(t){if(this._imagesPerTile>1)for(var e=0;e<this._imagesPerTile;e++){var i=t+"/"+e;i in this._freshTiles&&delete this._freshTiles[i]}else t in this._freshTiles&&delete this._freshTiles[t];return L.GridLayer.prototype._removeTile.call(this,t)}}),L.gridLayer.googleMutant=function(t){return new L.GridLayer.GoogleMutant(t)},TDMap.Service.GoogleMutant=L.GridLayer.GoogleMutant,TDMap.Service.googleMutant=L.gridLayer.googleMutant,function(){var t=function(t){return t.extend({onAdd:function(t){L.TileLayer.prototype.onAdd.call(this,t),this.options.clickable&&(L.DomUtil.addClass(this._container,"leaflet-clickable-raster-layer"),this._needInitInteraction&&(this._initInteraction(),this._needInitInteraction=!1))},_needInitInteraction:!0,_initInteraction:function(){for(var t=this._container,e=["dblclick","click","mousedown","mouseover","mouseout","contextmenu"],i=0;i<e.length;i++)L.DomEvent.on(t,e[i],this._fireMouseEvent,this)},_fireMouseEvent:function(t){var e=this._map;if(!e.dragging||!e.dragging.moved()){var i=e.mouseEventToContainerPoint(t),a=e.containerPointToLayerPoint(i),r=e.layerPointToLatLng(a);this.fire(t.type,{latlng:r,layerPoint:a,containerPoint:i,originalEvent:t})}}})};L.TileLayer.Rosreestr=function(t){return t.extend({options:{tileSize:256},getTileUrl:function(t){var e=this._map,i=e.options.crs,a=this.options.tileSize,r=t.multiplyBy(a),n=r.add([a,a]),o=i.project(e.unproject(r,t.z)),s=i.project(e.unproject(n,t.z)),l=[o.x,s.y,s.x,o.y].join(",");return L.Util.template(this._url,L.extend({s:this._getSubdomain(t),bbox:l},this.options))}})}(L.TileLayer),L.tileLayer.Rosreestr=function(e,i){return i.clickable&&(L.TileLayer.Rosreestr=t(L.TileLayer.Rosreestr)),new L.TileLayer.Rosreestr(e,i)},TDMap.Service.RosreestrProvider=L.TileLayer.Rosreestr}(),L.GridLayer.YandexMutant=L.GridLayer.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,attribution:"",opacity:1,traffic:!1,noWrap:!1,type:"yandex#map"},possibleShortMapTypes:{schemaMap:"map",satelliteMap:"satellite",hybridMap:"hybrid",publicMap:"publicMap",publicMapInHybridView:"publicMapHybrid"},_getPossibleMapType:function(t){var e="yandex#map";if("string"!=typeof t)return e;for(var i in this.possibleShortMapTypes){if(t===this.possibleShortMapTypes[i]){e="yandex#"+t;break}t==="yandex#"+this.possibleShortMapTypes[i]&&(e=t)}return e},initialize:function(t){t&&t.type&&(t.type=this._getPossibleMapType(t.type)),L.GridLayer.prototype.initialize.call(this,t),this._ready=!!window.ymaps&&!!window.ymaps.Map,this._YAPIPromise=this._ready?Promise.resolve(window.ymaps):new Promise(function(t,e){var i=0,a=null;a=setInterval(function(){return i>=10?(clearInterval(a),e(new Error("window.ymaps not found after 10 attempts"))):window.ymaps?(clearInterval(a),void 0===ymaps.Map?ymaps.load(["package.map"],t,ymaps):t(window.ymaps)):void i++},500)}),this._tileCallbacks={},this._freshTiles={},this._imagesPerTile=1,this.createTile=this._createSingleTile},onAdd:function(t){L.GridLayer.prototype.onAdd.call(this,t),this._initMutantContainer(),this._YAPIPromise.then(function(){this._ready=!0,this._map=t,this._initMutant(),t.on("viewreset",this._reset,this),t.on("move",this._update,this),t.on("zoomend",this._handleZoomAnim,this),t.on("resize",this._resize,this),t._controlCorners.bottomright.style.marginBottom="4em",this._reset(),this._update()}.bind(this))},onRemove:function(t){L.GridLayer.prototype.onRemove.call(this,t),t._container.removeChild(this._mutantContainer),console.log(this._map),this._mutantContainer=void 0,t.off("viewreset",this._reset,this),t.off("move",this._update,this),t.off("zoomend",this._handleZoomAnim,this),t.off("resize",this._resize,this),t._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(t){this.options.opacity=t,t<1&&L.DomUtil.setOpacity(this._mutantContainer,t)},setElementSize:function(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px"},_initMutantContainer:function(){this._mutantContainer||(this._mutantContainer=L.DomUtil.create("div","leaflet-yandex-mutant leaflet-top leaflet-left"),this._mutantContainer.id="_MutantContainer_"+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.zIndex="auto",this._mutantContainer.style.pointerEvents="none",this._map.getContainer().appendChild(this._mutantContainer)),this.setOpacity(this.options.opacity),this.setElementSize(this._mutantContainer,this._map.getSize()),this._attachObserver(this._mutantContainer)},_initMutant:function(){if(this._ready&&this._mutantContainer){if(this._mutantCenter=[0,0],this.options.traffic&&(void 0===ymaps.control||void 0===ymaps.control.TrafficControl))return ymaps.load(["package.traffic","package.controls"],this._initMutant,this);var t=new ymaps.Map(this._mutantContainer,{center:this._mutantCenter,zoom:0,type:this.options.type,behaviors:[],controls:[]},{autoFitToViewport:"none",exitFullscreenByEsc:!1,yandexMapDisablePoiInteractivity:!0});this.options.traffic&&t.controls.add(new ymaps.control.TrafficControl({shown:!0})),"yandex#null"===this.options.type&&(this.options.type=new ymaps.MapType("null",[]),t.container.getElement().style.background="transparent"),t.setType(this.options.type),this._mutant=t,this.fire("spawned",{mapObject:t})}},_attachObserver:function(t){new MutationObserver(this._onMutations.bind(this)).observe(t,{childList:!0,subtree:!0})},_onMutations:function(t){for(var e=0;e<t.length;++e)for(var i=t[e],a=0;a<i.addedNodes.length;++a){var r=i.addedNodes[a];r instanceof HTMLImageElement?this._onMutatedImage(r):r instanceof HTMLElement&&Array.prototype.forEach.call(r.querySelectorAll("img"),this._onMutatedImage.bind(this))}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+)/,_staticRegExp:/StaticMapService\.GetMapImage/,_onMutatedImage:function(t){console.log(t);var e,i,a,r=t.src.match(this._roadRegexp);if(r?(e={z:r[1],x:r[2],y:r[3]},this._imagesPerTile>1&&(t.style.zIndex=1),i=1):(r=t.src.match(this._satRegexp),r&&(e={x:r[1],y:r[2],z:r[3]}),i=0),e){var n=this._tileCoordsToKey(e);this._imagesPerTile>1&&(n+="/"+i),n in this._tileCallbacks&&this._tileCallbacks[n]?(this._tileCallbacks[n].pop()(t),this._tileCallbacks[n].length||delete this._tileCallbacks[n]):(a=t.parentNode,a&&(a.removeChild(t),a.removeChild=L.Util.falseFn),n in this._freshTiles?this._freshTiles[n].push(t):this._freshTiles[n]=[t])}else t.src.match(this._staticRegExp)&&(a=t.parentNode)&&t.parentNode.replaceChild(L.DomUtil.create("img"),t)},_createSingleTile:function(t,e){var i=this._tileCoordsToKey(t);if(i in this._freshTiles){var a=this._freshTiles[i].pop();return this._freshTiles[i].length||delete this._freshTiles[i],L.Util.requestAnimFrame(e),a}var r=L.DomUtil.create("div");return this._tileCallbacks[i]=this._tileCallbacks[i]||[],this._tileCallbacks[i].push(function(t){return function(i){var a=i.parentNode;a&&(a.removeChild(i),a.removeChild=L.Util.falseFn),t.appendChild(i),e()}.bind(this)}.bind(this)(r)),r},_checkZoomLevels:function(){void 0!==this._map.getZoom()&&this._mutant.getZoom()!==this._map.getZoom()&&this._map.setZoom(this._mutant.getZoom())},_reset:function(){this._initContainer()},_update:function(){if(L.GridLayer.prototype._update.call(this),this._mutant){var t=this._map.getCenter(),e=[t.lat,t.lng];this._mutant.setCenter(e),console.log(this._mutant);void 0!==this._map.getZoom()&&this._mutant.setZoom(Math.round(this._map.getZoom()))}},_resize:function(){var t=this._map.getSize();this._mutantContainer.style.width===t.x&&this._mutantContainer.style.height===t.y||(this.setElementSize(this._mutantContainer,t),this._mutant&&this._mutant.container.fitToViewport())},_handleZoomAnim:function(){var t=this._map.getCenter(),e=[t.lat,t.lng];this._mutant.setCenter(e),this._mutant.setZoom(Math.round(this._map.getZoom()))},_removeTile:function(t){if(this._imagesPerTile>1)for(var e=0;e<this._imagesPerTile;e++){var i=t+"/"+e;i in this._freshTiles&&delete this._freshTiles[i]}else t in this._freshTiles&&delete this._freshTiles[t];return L.GridLayer.prototype._removeTile.call(this,t)}}),L.gridLayer.yandexMutant=function(t){return new L.GridLayer.YandexMutant(t)},L.gridLayer.yandexMutant=function(t){return new L.GridLayer.YandexMutant(t)},TDMap.Service.YandexMutant=L.gridLayer.YandexMutant,TDMap.Service.yandexMutant=L.gridLayer.yandexMutant,TDMap.Service.YandexProvider=L.Layer.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,attribution:"",opacity:1,traffic:!1},possibleShortMapTypes:{schemaMap:"map",satelliteMap:"satellite",hybridMap:"hybrid",publicMap:"publicMap",publicMapInHybridView:"publicMapHybrid"},_getPossibleMapType:function(t){var e="yandex#map";if("string"!=typeof t)return e;for(var i in this.possibleShortMapTypes){if(t===this.possibleShortMapTypes[i]){e="yandex#"+t;break}t==="yandex#"+this.possibleShortMapTypes[i]&&(e=t)}return e},initialize:function(t,e){L.Util.setOptions(this,e),this._type=this._getPossibleMapType(t)},onAdd:function(t,e){this._map=t,this._insertAtTheBottom=e,this._initContainer(),this._initMapObject(),t.on("viewreset",this._reset,this),this._limitedUpdate=L.Util.throttle(this._update,1,this),t.on("move",this._update,this),t._controlCorners.bottomright.style.marginBottom="3em",this._reset(),this._update(!0)},onRemove:function(t){this._map._container.removeChild(this._container),this._map.off("viewreset",this._reset,this),this._map.off("move",this._update,this),t._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(t){this.options.opacity=t,t<1&&L.DomUtil.setOpacity(this._container,t)},setElementSize:function(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px"},_initContainer:function(){var t=this._map._container,e=t.firstChild;this._container||(this._container=L.DomUtil.create("div","leaflet-yandex-layer leaflet-top leaflet-left"),this._container.id="_YMapContainer_"+L.Util.stamp(this),this._container.style.zIndex="auto"),this.options.overlay&&(e=this._map._container.getElementsByClassName("leaflet-map-pane")[0],e=e.nextSibling,L.Browser.opera&&(this._container.className+=" leaflet-objects-pane")),t.insertBefore(this._container,e),this.setOpacity(this.options.opacity),this.setElementSize(this._container,this._map.getSize())},_initMapObject:function(){if(!this._yandex){if(void 0===ymaps.Map)return ymaps.load(["package.map"],this._initMapObject,this);if(this.options.traffic&&(void 0===ymaps.control||void 0===ymaps.control.TrafficControl))return ymaps.load(["package.traffic","package.controls"],this._initMapObject,this);var t=new ymaps.Map(this._container,{center:[0,0],zoom:0,behaviors:[],controls:[]});this.options.traffic&&t.controls.add(new ymaps.control.TrafficControl({shown:!0})),"yandex#null"===this._type&&(this._type=new ymaps.MapType("null",[]),t.container.getElement().style.background="transparent"),t.setType(this._type),this._yandex=t,this._update(!0),this.fire("MapObjectInitialized",{mapObject:t})}},_reset:function(){this._initContainer()},_update:function(t){if(this._yandex){this._resize(t);var e=this._map.getCenter(),i=[e.lat,e.lng];this._yandex.setCenter(i);void 0!==this._map.getZoom()&&this._yandex.setZoom(Math.round(this._map.getZoom()))}},_resize:function(t){var e=this._map.getSize(),i=this._container.style;i.width===e.x+"px"&&i.height===e.y+"px"&&t!==!0||(this.setElementSize(this._container,e),this._yandex.container.fitToViewport())}}),TDMap.Routing.RouteProvider=L.Class.extend({options:{baseUrl:"http://188.134.5.249:3030/route/v1/driving/"},initialize:function(t){L.setOptions(this,t),this.startPoint=null,this.endPoint=null,this.middlePoints=[]},request:function(){this.checkPoints();var t=this;return TDMap.Utils.Promise.httpPromise()({type:"GET",url:t.getUrl(),params:{alternatives:!1,overview:!1,steps:!0}})},parceResult:function(t){for(var e=[],i=0;i<t.routes.length;i++){var a={distance:t.routes[i].distance,waypoints:t.waypoints};a.legs=[];for(var r=0;r<t.routes[i].legs.length;r++){var n={distance:t.routes[i].legs[r].distance,summary:t.routes[i].legs[r].summary};n.steps=[];for(var o=0;o<t.routes[i].legs[r].steps.length;o++){var s={distance:t.routes[i].legs[r].steps[o].distance,geometry:this._decode(t.routes[i].legs[r].steps[o].geometry),mode:t.routes[i].legs[r].steps[o].mode,name:t.routes[i].legs[r].steps[o].name};n.steps.push(s)}a.legs.push(n)}e.push(a)}return e},getUrl:function(){return this.options.url+this.getEndPointAsString()+";"+this.getMiddlePointsAsString()+this.getStartPointAsString()},setStartPoint:function(t){return t instanceof L.LatLng?this.startPoint=t:this.startPoint=new L.LatLng(t[0],t[1]),this},setEndPoint:function(t){return t instanceof L.LatLng?this.endPoint=t:this.endPoint=new L.LatLng(t[0],t[1]),this},setMiddlePoints:function(t){this.middlePoints.length>0&&(this.middlePoints=[]);for(var e=0;e<t.length;e++){var i=t[e];i?this.middlePoints.push(i):this.middlePoints.push(new L.LatLng(i[0],i[1]))}return this},getStartPoint:function(){return this.startPoint},getEndPoint:function(){return this.endPoint},getMiddlePoints:function(){return this.middlePoints},getStartPointAsString:function(){return this.startPoint.lng+","+this.startPoint.lat},getEndPointAsString:function(){return this.endPoint.lng+","+this.endPoint.lat},getMiddlePointsAsString:function(){var t="";if(this.middlePoints.length>0)for(var e=0;e<this.middlePoints.length;e++)t=t+this.middlePoints[e].lng+","+this.middlePoints[e].lat+";";return t},checkPoints:function(){return null===this.startPoint||void 0===this.startPoint?void alert("Не задана начальная точка"):null===this.endPoint||void 0===this.endPoint?void alert("Не задана конечная точка"):void 0},_decode:function(t,e){for(var i,a,r=0,n=0,o=0,s=[],l=0,d=0,h=null,p=Math.pow(10,e||5);r<t.length;){h=null,l=0,d=0;do{h=t.charCodeAt(r++)-63,d|=(31&h)<<l,l+=5}while(h>=32);i=1&d?~(d>>1):d>>1,l=d=0;do{h=t.charCodeAt(r++)-63,d|=(31&h)<<l,l+=5}while(h>=32);a=1&d?~(d>>1):d>>1,n+=i,o+=a,s.push([n/p,o/p])}return s}}),TDMap.Routing.RouterPolyline=L.Polyline.extend({options:{className:"leaflet-interactive router-polyline"}}),TDMap.Routing.RouterSubhiddenVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon router-hidden-edge"}}),TDMap.Routing.RouterStartEndVertex=L.Marker.extend({options:{className:"router-start-end"}}),TDMap.Routing.RouterWayMarker=L.Marker.extend({initialize:function(t,e){var i={draggable:!0,icon:L.divIcon({className:"router-way-marker"})};this.editTools=e,L.Marker.prototype.initialize.call(this,t,i),this.editTools.wayPoints.addLayer(this),this.on("dragend",this.onDragEnd,this),this.on("dblclick",this.removeOnClick,this)},onDragEnd:function(t){this.editTools.redrawRouteViaAndEnd(this)},removeOnClick:function(t){this.remove(),delete this.editTools.wayPoints._layers[this._leaflet_id],this.editTools.redrawRouteViaAndEnd(),L.Draggable._dragging=!1}}),TDMap.Routing.RouterEditVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon router-edge"},onAdd:function(t){L.Editable.VertexMarker.prototype.onAdd.call(this,t),this.map=t,this.on("mouseout",this.onMouseOut,this)},onMouseOut:function(t){this.remove()},onMouseDown:function(t){L.Editable.VertexMarker.prototype.onDragEnd.call(this,t),this.replaceEditOnViaMarker(t)},replaceEditOnViaMarker:function(t){new TDMap.Routing.RouterWayMarker(t.target._latlng,t.layer.editor.tools);t.layer.editor.refresh(),L.Draggable._dragging=!1,this.remove()}}),TDMap.Routing.Router=L.Editable.extend({options:{vertexMarkerClass:TDMap.Routing.RouterSubhiddenVertex,markerClass:TDMap.Routing.RouterStartEndVertex,polylineClass:TDMap.Routing.RouterPolyline,skipMiddleMarkers:!0},initialize:function(t,e){L.Editable.prototype.initialize.call(this,t,e),this.tools=this,this.map=t,this.routeProvider=new TDMap.Routing.RouteProvider,this.startPoint=null,this.endPoint=null,this.wayPoints=(new L.layerGroup).addTo(this.map),t.on("router:stop",function(){this.abortDrawing()},this)},abortDrawing:function(){for(var t in this.editLayer._layers)this.editLayer._layers[t].remove(),delete this.editLayer._layers[t];this.stopDrawing(),this.wayPoints.remove(),this.featuresLayer.remove()},startRouter:function(){this.on("editable:drawing:commit",this.endRouter),this.on("editable:dragstart",this.showMCADPoints),this.on("editable:dragend",this.redrawRouteViaAndEnd),this.on("editable:dragend",this.hideMCADPoints),L.Editable.prototype.startMarker.call(this)},endRouter:function(t){t.latlng;if(null===t.editTools.startPoint||"start"===t.layer.options.routePoint){this.startPoint=t.layer,"editable:drawing:commit"===t.type&&(t.layer.options.routePoint="start");for(var e in t.editTools.editLayer._layers)t.editTools.editLayer._layers[e].remove(),delete t.editTools.editLayer._layers[e];this.getElevenRoutesThenOne()}},bringEndPointToMcad:function(t){for(var e=this.arrayOfMCAD(),i=[],a=0;a<e.length;a++)i.push({layerLatLng:e[a],distance:t._latlng.distanceTo(e[a])});t.setLatLng(i.sort(this.comFunction).slice(0,1)[0].layerLatLng)},redrawRouteViaAndEnd:function(t){var e;if(t){var i=t.layer||t;e=t.editTools||t.editor.tools,"end"===i.options.routePoint&&e.bringEndPointToMcad(t.layer)}else e=this;if(e.endPoint){var a=[];e.wayPoints.eachLayer(function(t){a.push(t._latlng)}),e.routeProvider.setStartPoint(e.startPoint._latlng).setEndPoint(e.endPoint._latlng).setMiddlePoints(a).request().then(function(t){e.clearRoutes().drawRoute(e.routeProvider.parceResult(t.data)[0])})}},clearRoutes:function(){return this.route.remove(),delete this.route,this},drawRoute:function(t){for(var e=this,i=[],a=0;a<t.legs.length;a++)for(var r=0;r<t.legs[a].steps.length;r++)i=i.concat(t.legs[a].steps[r].geometry);for(var n=i.length-2;n>=0;n--)i[n][0]===i[n+1][0]&&i[n][1]===i[n+1][1]&&i.splice(n,1);if(this.route=this.createPolyline(i,{polylineClass:this.options.polylineClass,waypoints:t.waypoints}).addTo(this.featuresLayer),this.route.on("mouseover mousemove",e.routeMouseOver),!this.endPoint){var o=this.createMarker(i[0],{markerClass:this.options.markerClass,routePoint:"end"});this.featuresLayer.addLayer(o),this.endPoint=o}return this.route.on("click",this.clickWayMarker),this.featuresLayer.eachLayer(function(t){t.editor||t.toggleEdit()}),this.fireEvent("router:ready",{route:t}),this},clickWayMarker:function(t){new TDMap.Routing.RouterWayMarker(t.latlng,t.target.editor.tools);t.target.editor.refresh()},routeMouseOver:function(t){t.target.editor.tools.clearAllViaMarkers().createViaMarker(t)},clearAllViaMarkers:function(){var t=this;return this.editMarker&&this.editMarker.remove(),this.editLayer.eachLayer(function(e){e instanceof TDMap.Routing.RouterEditVertex&&(e.remove(),delete t.editLayer._layers[e._leaflet_id])}),this},createViaMarker:function(t){var e=t.target,i=this._closestPolylineData(t.layerPoint,e);this.editMarker=new TDMap.Routing.RouterEditVertex(this.map.layerPointToLatLng(i.point),e.getLatLngs(),e.editor),
this.editLayer.addLayer(this.editMarker)},_closestPolylineData:function(t,e,i){for(var a=e.getLatLngs(),r=e._rings[0],n=[],o=r.length-2;o>=0;o--){var s=r[o],l=r[o+1],d=L.LineUtil.pointToSegmentDistance(t,s,l);n.push({distance:d,from:s,to:l,fl:a[o],tl:a[o+1],i:o})}var h=n.sort(this.comFunction),p=h[0];return{point:L.LineUtil.closestPointOnSegment(t,p.from,p.to),features:p}},getElevenRoutesThenOne:function(){for(var t=this,e=this.getElevenPoints(),i=[],a=[],r=0;r<e.length;r++){var n=new TDMap.Routing.RouteProvider;n.setStartPoint(this.startPoint._latlng).setEndPoint(e[r].layerLatLng).setMiddlePoints(this.wayPoints),a.push(n.request())}angular.injector(["ng"]).get("$q").all(a).then(function(e){for(var a=0;a<e.length;a++)i.push(t.routeProvider.parceResult(e[a].data));var r=i.sort(t.comFunction2);t.drawRoute(r[0][0])})},getElevenPoints:function(){for(var t=this.arrayOfMCAD(),e=[],i=0;i<t.length;i++)e.push({layerLatLng:t[i],distance:this.startPoint._latlng.distanceTo(t[i])});return e.sort(this.comFunction).slice(0,11)},comFunction:function(t,e){return t.distance<e.distance?-1:t.distance>e.distance?1:0},comFunction2:function(t,e){return t[0].distance<e[0].distance?-1:t[0].distance>e[0].distance?1:0},showMCADPoints:function(t){if("start"!==t.layer.options.routePoint){var e=this.arrayOfMCAD();this.mcadPoints=(new L.LayerGroup).addTo(this.map);for(var i=0;i<e.length;i++)this.mcadPoints.addLayer(new L.circleMarker(e[i],{color:"#E53935",weight:2,fillColor:"#E53935",fillOpacity:.4}))}},hideMCADPoints:function(){this.mcadPoints&&(this.mcadPoints.remove(),delete this.mcadPoints)},arrayOfMCAD:function(){for(var t=[[37.370743963,55.7900346394],[37.378270044,55.7960801265],[37.3858805489,55.8090674539],[37.389455252,55.813351974],[37.3903679421,55.8159160498],[37.3919461355,55.8212680135],[37.3953893225,55.8333960946],[37.394925847,55.8319678193],[37.3956507702,55.8356785564],[37.392347022,55.8497441067],[37.3974159383,55.8591232043],[37.399958636,55.8625941994],[37.4031815731,55.8656151612],[37.4191322597,55.8738805922],[37.4258562192,55.8760086759],[37.4316175758,55.8778166554],[37.4439531536,55.8815563457],[37.4512047621,55.8827081777],[37.4862720291,55.8882668866],[37.4868139389,55.8884188401],[37.490236527,55.8895784658],[37.4949211944,55.8916017297],[37.4996557746,55.8936968563],[37.5481067871,55.9084475027],[37.5427946452,55.9078799665],[37.5708028243,55.910857441],[37.5818763228,55.9109853275],[37.5877874176,55.9101860305],[37.5935701654,55.908703291],[37.6295144706,55.8997257115],[37.6664142483,55.8956172896],[37.6715481304,55.8954200531],[37.682538441,55.8951108695],[37.6992520794,55.8940873477],[37.7073902333,55.8917043562],[37.7131420827,55.8891239499],[37.7249975475,55.8830294581],[37.730901512,55.8801391721],[37.8278463193,55.8302772253],[37.8301660734,55.8289422831],[37.8391218456,55.814708952],[37.8394926259,55.8111511412],[37.8396067122,55.8101895149],[37.8429437356,55.7779506079],[37.8433050088,55.7748493065],[37.8436282532,55.7707316803],[37.8434286022,55.7670200964],[37.8428771853,55.7553107823],[37.8423542899,55.7460542456],[37.8419930167,55.740777572],[37.8405205908,55.7291252899],[37.8390659908,55.7170578494],[37.8378966066,55.712804242],[37.836848439,55.7107997849],[37.8314293412,55.7005991606],[37.8314970799,55.6854640667],[37.8323455965,55.683124557],[37.8395686834,55.6574611634],[37.8387486884,55.6553452535],[37.8348982768,55.6505136313],[37.8273828438,55.6453112266],[37.8204948853,55.6408043314],[37.8180919433,55.6392267955],[37.7986117128,55.6264190387],[37.798233802,55.6261291856],[37.7809614181,55.6167931363],[37.7470088691,55.5989104603],[37.7396645655,55.5958352148],[37.7323202619,55.5927731589],[37.7219336578,55.588387825],[37.7191765729,55.5872863778],[37.703382755,55.5814025142],[37.6896686348,55.5762500511],[37.6838335975,55.5741539404],[37.6500117722,55.5726892838],[37.6382585097,55.5733745886],[37.6352780059,55.5735761466],[37.6193059282,55.574511362],[37.6028775054,55.575462679],[37.6003390859,55.575615855],[37.5903850589,55.576671947],[37.5739281146,55.5805735977],[37.5698923128,55.5815167072],[37.5298765539,55.5911157886],[37.5259976207,55.5920264108],[37.4967972401,55.6066901578],[37.4937525628,55.6093362997],[37.4890179826,55.6134038409],[37.4711563511,55.6283977433],[37.4677480238,55.6313805399],[37.4600614614,55.6377881553],[37.4568100027,55.640673655],[37.4524580869,55.6446769169],[37.4289135331,55.666142281],[37.4255979009,55.6706382181],[37.4170271699,55.6820607217],[37.4153016151,55.6853328693],[37.4109805977,55.6925354533],[37.400178054,55.7007653533],[37.3953079964,55.7043493189],[37.3908015888,55.7076959317],[37.3830651137,55.7185373097],[37.3796710471,55.7252358495],[37.3747653376,55.7346873495],[37.3729470877,55.7384889855],[37.3689089091,55.7629799824],[37.3690515169,55.7672802708],[37.369179864,55.7696949637],[37.3693224718,55.7733768817],[37.3756970421,55.7931762657]],e=[],i=0;i<t.length;i++)e.push(new L.latLng(t[i][1],t[i][0]));return e}}),TDMap.Utils.GeoUtil=L.Util.extend({intersectionByBBox:function(t,e,i){this.map=i;var a=this.parseResult(this.isMultiPointInsideBBox(t,e));return"within"===a||"overlaps"===a},isMultiPointInsideBBox:function(t,e){for(var i=[],a=0;a<t.length;a++)i.push(this.pointIntersectionMath(t[a],e));return i},pointIntersectionMath:function(t,e){for(var i=t[0],a=t[1],r=!1,n=0,o=e.length-1;n<e.length;o=n++){var s=e[n][0],l=e[n][1],d=e[o][0],h=e[o][1];l>a!=h>a&&i<(d-s)*(a-l)/(h-l)+s&&(r=!r)}return r},parseResult:function(t){return t===!0&&"boolean"==typeof t?"within":t===!1&&"boolean"==typeof t?"no intersects":t.constructor===Array?(t.sort(),t[0]===t[t.length-1]&&t[0]===!0?"within":t[0]===t[t.length-1]&&t[0]===!1?"no intersects":"overlaps"):void 0}}),TDMap.MeasurmentUtils={},TDMap.MeasurmentUtils.MeasureLine=L.Polyline.extend({options:{className:"leaflet-interactive measurment-line"}}),TDMap.MeasurmentUtils.MeasurePolygon=L.Polygon.extend({options:{className:"leaflet-interactive measurment-polygon"}}),TDMap.MeasurmentUtils.MeasureVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon measurment-edge"},onAdd:function(t){L.Editable.VertexMarker.prototype.onAdd.call(this,t),this.on("mouseover",this.mouseover),this.on("mouseout",this.mouseout)},mouseover:function(t){this.editor.fireAndForward("editable:vertex:mouseover",t)},mouseout:function(t){this.editor.fireAndForward("editable:vertex:mouseout",t)}}),TDMap.MeasurmentUtils.MeasureMiddleVertex=L.Editable.MiddleMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon measurment-middleEdge"},onAdd:function(t){L.Editable.MiddleMarker.prototype.onAdd.call(this,t),this.on("mouseover",this.mouseover),this.on("mouseout",this.mouseout)},mouseover:function(t){t.left=this.left,t.right=this.right,this.editor.fireAndForward("editable:middlemarker:mouseover",t)},mouseout:function(t){t.middleMarkerId=this._leaflet_id,this.editor.fireAndForward("editable:middlemarker:mouseout",t)}}),TDMap.Utils.Measurment=L.Editable.extend({options:{vertexMarkerClass:TDMap.MeasurmentUtils.MeasureVertex,polylineClass:TDMap.MeasurmentUtils.MeasureLine,polygonClass:TDMap.MeasurmentUtils.MeasurePolygon,middleMarkerClass:TDMap.MeasurmentUtils.MeasureMiddleVertex,lineGuideOptions:{className:"measurment-lineguide"}},initialize:function(t,e){L.Editable.prototype.initialize.call(this,t),L.setOptions(this,e),t.measureTools=this,this.map=t;var i=this;t.on("stopmeasure",function(){var t;i.abortDrawing();for(var e in i.featuresLayer._layers)t=i.featuresLayer._layers[e]._leaflet_id;i.removeLabel(t),i.featuresLayer.remove(),i.map.off("zoomend",i.dravingZoomEnd)},this)},disableMapZoom:function(){this.map.doubleClickZoom&&this.map.doubleClickZoom.disable(),this.map.touchZoom&&this.map.touchZoom.disable()},enableMapZoom:function(){this.map.doubleClickZoom||this.map.doubleClickZoom.enable(),this.map.touchZoom||this.map.touchZoom.enable()},abortDrawing:function(){this.off("editable:vertex:mouseover editable:vertex:mouseout editable:middlemarker:mouseover editable:middlemarker:mouseout editable:vertex:drag editable:vertex:dragend editable:drawing:move",this.preMeasureCookLayer),this.off("editable:vertex:drag editable:vertex:dragend editable:drawing:move editable:vertex:mouseover editable:vertex:mouseout editable:middlemarker:mouseout",this.preMeasureCookLayer),this.off("editable:drawing:end",this.dravingLineEnd),this.off("editable:drawing:end",this.dravingPolygonEnd),this.enableMapZoom(),this.stopDrawing()},startPolylineMeasure:function(){this.disableMapZoom(),this.on("editable:vertex:mouseover editable:vertex:mouseout editable:middlemarker:mouseover editable:middlemarker:mouseout editable:vertex:drag editable:vertex:dragend editable:drawing:move",this.preMeasureCookLayer),this.on("editable:drawing:end",this.dravingLineEnd),L.Editable.prototype.startPolyline.call(this)},dravingLineEnd:function(t){this.off("editable:drawing:move",this.preMeasureCookLayer),this.preMeasureCookLayer(t),this.enableMapZoom(),this.map.on("zoomend",this.dravingZoomEnd)},startPolygonMeasure:function(){this.disableMapZoom(),this.on("editable:vertex:drag editable:vertex:dragend editable:drawing:move editable:vertex:mouseover editable:vertex:mouseout editable:middlemarker:mouseout",this.preMeasureCookLayer),this.on("editable:drawing:end",this.dravingPolygonEnd),L.Editable.prototype.startPolygon.call(this)},dravingPolygonEnd:function(t){var e=this;e.off("editable:drawing:move",e.preMeasureCookLayer),e.preMeasureCookLayer(t),e.enableMapZoom(),e.map.on("zoomend",this.dravingZoomEnd),e.on("editable:middlemarker:mouseover",e.preMeasureCookLayer)},dravingZoomEnd:function(t){for(var e in t.target.measureTools.featuresLayer._layers)t.layer=t.target.measureTools.featuresLayer._layers[e],t.layer.toGeoJSON().geometry.type,t.target.measureTools.preMeasureCookLayer(t)},preMeasureCookLayer:function(t){"Polygon"===(t.layer||t.target).toGeoJSON().geometry.type?t.target.measureTools?t.target.measureTools.preMeasureCookPolygonLayer(t):t.editTools.preMeasureCookPolygonLayer(t):t.target.measureTools?t.target.measureTools.preMeasureCookLineLayer(t):t.editTools.preMeasureCookLineLayer(t)},preMeasureCookLineLayer:function(t){for(var e,i=t.layer,a=this._getLineLatLngs(i),r=[],n=[],o=0;o<a.length;o++)r.push(a[o]);if(this.removeLabel(i._leaflet_id),"editable:drawing:move"===t.type){var s=t.latlng;e=t.layerPoint,r.push(s)}else if("editable:drawing:end"===t.type||"editable:vertex:dragend"===t.type||"editable:vertex:mouseout"===t.type||"editable:middlemarker:mouseout"===t.type)e=i._rings[0][i._rings[0].length-1];else if("editable:vertex:drag"===t.type)e=t.vertex.dragging._draggable._newPos;else if("editable:vertex:mouseover"===t.type){e=t.layerPoint;for(var l,d=0;d<i._rings[0].length;d++)i._rings[0][d].x===e.x&&i._rings[0][d].y===e.y&&(l=d);n=[];for(var h=0;h<a.length;h++)h-1<l&&n.push(a[h]);r=n}else"editable:middlemarker:mouseover"===t.type&&(e=t.layerPoint,n=[],n.push(t.left.latlng),n.push(t.right.latlng),r=n);if(!(r.length<1)){var p=this;"zoomend"===t.type?setTimeout(function(){p.createMouseMoveLabel({pathLength:p._getPerimeter(r)},i._rings[0][i._rings[0].length-1],i._leaflet_id)},50):this.createMouseMoveLabel({pathLength:p._getPerimeter(r)},e,i._leaflet_id)}},preMeasureCookPolygonLayer:function(t){for(var e,i=this,a=t.layer||t.target,r=this._getLineLatLngs(a),n=[],o=!1,s=0;s<r[0].length;s++)n.push(r[0][s]);if("editable:drawing:move"===t.type){var l=t.latlng;e=t.layerPoint||t.vertex.dragging._draggable._newPos,n.push(l),void 0!==r[0][r.length-1]&&n.push(r[0][r.length-1])}else"editable:drawing:end"===t.type?(e=i.map.latLngToContainerPoint(a.getCenter()),n.push(r[0][r.length-1]),o=!0):"editable:vertex:drag"===t.type?(e=t.vertex.dragging._draggable._newPos,n.push(r[0][r.length-1])):"editable:vertex:mouseover"===t.type&&(e=t.layerPoint,n.push(r[0][r.length-1]));n.length<2||("zoomend"===t.type||"editable:vertex:mouseout"===t.type||"editable:middlemarker:mouseout"===t.type||"editable:vertex:dragend"===t.type?(this.removeLabel(a._leaflet_id),setTimeout(function(){var t=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");e=i.map.latLngToContainerPoint(a.getCenter()),e.x=e.x-t[t.length-2],e.y=e.y-t[t.length-1],n.push(r[0][r.length-1]),i.removeLabel(a._leaflet_id),o=!0,i.createMouseMoveLabel({pathLength:i._getPerimeter(n),pathSquare:i.getArea(n),screenCordsShift:o},e,a._leaflet_id)},50)):(this.removeLabel(a._leaflet_id),this.createMouseMoveLabel({pathLength:i._getPerimeter(n),pathSquare:i.getArea(n),screenCordsShift:o},e,a._leaflet_id)))},_getLineLatLngs:function(t){return t.editor.getLatLngs()},getDistance:function(t){return t.latlng1.distanceTo(t.latlng2)},_getPerimeter:function(t){for(var e=0,i=0,a=1;a<t.length;a++){var r=t[a-1],n=t[a];i=this.getDistance({latlng1:r,latlng2:n}),e+=Number(i)}return this.readableDistance(e)},getArea:function(t){var e=parseFloat(this.geodesicArea(t));return this.readableArea(e)},geodesicArea:function(t){var e,i,a=t.length,r=0,n=.017453292519943295;if(a>2){for(var o=0;o<a;o++)e=t[o],i=t[(o+1)%a],r+=(i.lng-e.lng)*n*(2+Math.sin(e.lat*n)+Math.sin(i.lat*n));r=6378137*r*6378137/2}return Math.abs(r)},readableDistance:function(t){return t>1e4?L.Util.template("{distance} км",{distance:(t/1e3).toFixed(3)}):L.Util.template("{distance} м",{distance:(t/1).toFixed(1)})},readableArea:function(t){function e(t){var e=t.toString().split(".");return e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),e.join(".")}var i=L.Util.template("{area} м²",{area:t.toFixed(0)});i=e(i);var a=t/1e4,r=L.Util.template("{gaArea} Га",{gaArea:a.toFixed(2)});return r=e(r),i+" / "+r},createMouseMoveLabel:function(t,e,i){function a(t,e){t.each(function(){for(var t=d3.select(this),i=r.split("_"),a=!0,n=[],o=0,s=t.attr("x"),l=t.attr("y"),d=t.text(null).append("tspan").attr("x",s).attr("y",l).attr("dy","0em");a;)a=i.pop(),n.push(a),d.text(n.join(" ")),d.node().getComputedTextLength()>e&&(n.pop(),d.text(n.join("/")),n=[a],d=t.append("tspan").attr("x",s).attr("y",l).attr("dy",1.1*++o+0+"em").text(a))})}var r,n=0,o=0;if(t.pathLength&&(r="Расстояние: "+t.pathLength),t.pathSquare&&(r="Периметр: "+t.pathLength,r=r+"_Площадь: "+t.pathSquare),t.screenCordsShift&&(n=-75,o=15),void 0!==r){var s,l=d3.select(".leaflet-overlay-pane").select("svg").append("g").attr("class","measurment"+i),d=l.append("rect"),h=l.append("text").attr("x",e.x+25+n).attr("y",e.y-15+o).attr("class","measurment-label-text").call(a,180);if(null!==h.node()){s=h.node().getBBox();var p=s.width+6,u=s.height+2;d.attr("class","leaflet-measure-label-rectangle").attr("width",p+5).attr("height",u).attr("x",s.x-5).attr("y",s.y-1).style("fill","white").style("fill-opacity",.5).style("stroke","#3f51b5").style("stroke-width","1px").style("stroke-opacity",1)}}},removeLabel:function(t){$(".measurment"+t).remove()},checkAndClearAllLabels:function(){$("[class^='measurment']").remove()}}),TDMap.Utils.Promise={getPromise:function(t,e,i){var a={url:t,type:"GET"};return null!==e&&void 0!==e&&(a.params=e),null!==i&&void 0!==i&&(a.headers=i),console.log(a),console.log($.get(a)),$.get(a)}},TDMap.Utils.CadastrSearchProviderPPK5=function(t){this.map=t},TDMap.Utils.CadastrSearchProviderPPK5.prototype={getDataByMask:function(t){},getDataByMaskAsynch:function(t){var e=$.Deferred();return function(){function i(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var a={text:t,tolerance:"16391",limit:16,callback:"JQuery"+i()+i()},r=[],n=[];this[a.callback]=function(t){};var o=Number(t.split(":")[0]).toString()+":"+Number(t.split(":")[1]).toString()+":"+Number(t.split(":")[2]).toString()+":"+Number(t.split(":")[3]).toString();$.ajax({url:"https://pkk5.rosreestr.ru/api/features/1/"+o,type:"GET",dataType:"jsonp",success:function(t){if(void 0!==t.feature&&null!==t.feature)if(t.feature.center&&t.feature.extent){var i=L.Projection.SphericalMercator.unproject(L.point(t.feature.center.x,t.feature.center.y)),a={type:"Feature",geojson:{type:"Point",coordinates:[i[Object.keys(i)[1]],i[Object.keys(i)[0]]]}};a.properties=t.feature.attrs,a.properties.extent=t.feature.extent,a.properties.center=t.feature.center,r.push(a),e.resolve(r,"withCoords")}else n.push({type:"Feature",properties:{cn:t.feature.attrs.cn,id:t.feature.attrs.id}}),e.resolve(n,"withoutCoords");else e.resolve([],"noObjects")},error:function(t){e.reject(" Failed: "+t)}})}(),e.promise()},getPointsOfImageByMaskAsynch:function(t,e){var i=$.Deferred();return function(){var a={dpi:"96",transparent:"true",format:"png32",layers:"show:6,7",bbox:e.bbox3857,bboxSR:e.bboxSR,imageSR:e.imageSR,size:e.size,layerDefs:JSON.stringify({6:"ID = '"+t+"'",7:"ID = '"+t+"'"}),f:"image"};L.Util.getParamString(a),$.ajax({url:"http://pkk5.rosreestr.ru/arcgis/rest/services/Cadastre/CadastreSelected/MapServer/export?",type:"GET",data:a,success:function(t){var e=new Image;e.setAttribute("crossOrigin","anonymous"),e.onload=function(){var t,i=MSQR(e,{tolerance:1.5,path2D:!0,maxShapes:25}),r=document.createElement("canvas");r.width=e.width,r.height=e.height,t=r.getContext("2d"),t.drawImage(e,0,0),t.fillStyle="rgb(255, 255, 0)",t.beginPath();for(var n=0;n<i.length;n++)if(i[n].length>3)for(var o=0;o<i[n].length;o++)0===o?t.moveTo(i[n][o].x,i[n][o].y):(i[n].length,t.lineTo(i[n][o].x,i[n][o].y));t.rect(0,0,e.width,e.height),t.fill();for(var s=t.getImageData(0,0,e.width,e.height),l=0;l<s.data.length;l+=4)0===s.data[l+3]?(s.data[l]=255,s.data[l+1]=0,s.data[l+2]=0,s.data[l+3]=255):(s.data[l]=0,s.data[l+1]=0,s.data[l+2]=0,s.data[l+3]=0);t.putImageData(s,0,0);for(var d=MSQR(t,{tolerance:1.5,path2D:!0,maxShapes:100}),h=[],p=0;p<i.length;p++)i[p].length>2&&h.push(i[p]);for(var u=[],c=d.length-1;c>=0;c--)d[c].length>2&&u.push(d[c]);l.resolve(h,u,e.width,e.height,a.bbox)},e.src=this.url},error:function(t){i.reject(" Failed: "+t)}})}(),i.promise()},getDataByLocation:function(){},getDataByLocationAsynch:function(t){var e=$.Deferred();return function(){function i(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var a={text:t,tolerance:"16",limit:11,callback:"JQuery"+i()+i()},r=[];this[a.callback]=function(t){},$.ajax({url:"https://pkk5.rosreestr.ru/api/features/1?",type:"GET",data:a,dataType:"jsonp",jsonpCallback:a.callback,crossDomain:!0,success:function(t){t.features.length>0?($.each(t.features,function(t,e){var i=L.Projection.SphericalMercator.unproject(L.point(e.center.x,e.center.y));r.push({display_name:e.attrs.address,type:"Feature",geojson:{type:"Point",coordinates:[i[Object.keys(i)[1]],i[Object.keys(i)[0]]]},properties:{address:e.attrs.address,cn:e.attrs.cn,id:e.attrs.id,extent:e.extent,sort:e.sort,type:e.type}})}),e.resolve(r)):e.resolve([])},error:function(t){e.reject(" Failed: "+t)}})}(),e.promise()}},TDMap.Utils.CadastrSearchPPK5=function(t,e){this.map=t,this.options=e,this.pkk5Provider=new TDMap.Utils.CadastrSearchProviderPPK5(this.map)},TDMap.Utils.CadastrSearchPPK5.prototype={getGeoJsonByCadNum:function(t){var e=$.Deferred(),i=this;return i.pkk5Provider.getDataByMaskAsynch(t).then(function(t,a){var r=t;if("withCoords"===a){var n=[t[0].properties.extent.xmin,t[0].properties.extent.ymin,t[0].properties.extent.xmax,t[0].properties.extent.ymax],o=n.join(),s=new L.latLngBounds(L.Projection.SphericalMercator.unproject(new L.point(t[0].properties.extent.xmin,t[0].properties.extent.ymax)),L.Projection.SphericalMercator.unproject(new L.point(t[0].properties.extent.xmax,t[0].properties.extent.ymin))),l=i.map.getPixelBounds(s._northEast,18),d=i.map.getPixelBounds(s._southWest,18),h={x:null,y:null},p={x:null,y:null};h.x=l.min.x+i.map.getSize().x/2,h.y=l.min.y+i.map.getSize().y/2,p.x=d.min.x+i.map.getSize().x/2,p.y=d.min.y+i.map.getSize().y/2;var u,c,m=p.y-h.y,g=h.x-p.x;c=m/4096>1?m/4096:1,u=g/4096>1?g/4096:1;var f=[u,c].sort(),y=[g/f[1],m/f[1]],v=y.join();i.pkk5Provider.getPointsOfImageByMaskAsynch(t[0].properties.id,{bbox3857:o,bboxSR:"3857",imageSR:"3857",size:v}).then(function(t,a){for(var n={type:"MultiPolygon",coordinates:[]},o=0;o<t.length;o++){for(var s=[],l=[],d=0;d<t[o].length;d++){var u=L.point(t[o][d].x*f[1]+p.x,t[o][d].y*f[1]+h.y);l.push([i.map.unproject(u,18).lng,i.map.unproject(u,18).lat])}if(t[o].length>0){var c=L.point(t[o][0].x*f[1]+p.x,t[o][0].y*f[1]+h.y);l.push([i.map.unproject(c,18).lng,i.map.unproject(c,18).lat])}s.push(l),n.coordinates.push(s)}for(var m=[],g=0;g<a.length;g++){for(var y=[],v=0;v<a[g].length;v++){var _=L.point(a[g][v].x*f[1]+p.x,a[g][v].y*f[1]+h.y);y.push([i.map.unproject(_,18).lng,i.map.unproject(_,18).lat])}if(a[g].length>0){var b=L.point(a[g][0].x*f[1]+p.x,a[g][0].y*f[1]+h.y);y.push([i.map.unproject(b,18).lng,i.map.unproject(b,18).lat])}m.push(y)}if(m.length>0)for(var M=0;M<n.coordinates.length;M++)for(var x=0;x<m.length;x++){var P=TDMap.Utils.GeoUtil.intersectionByBBox(m[x],n.coordinates[M][0],i.map);P&&n.coordinates[M].push(m[x])}var T={type:"Feature"};T.geometry=n,T.properties=r[0].properties,null===T.properties.util_code&&(T.properties.util_code=999),null===T.properties.fp&&(T.properties.fp=999),null===T.properties.area_unit&&(T.properties.area_unit=999),null===T.properties.cad_unit&&(T.properties.cad_unit=999),null===T.properties.category_type&&(T.properties.category_type=999),null===T.properties.util_code&&(T.properties.util_code=999),null===T.properties.statecd&&(T.properties.statecd=999),e.resolve(T,"withCoords")},function(t){e.resolve(t,"error")})}else"withoutCoords"===a?e.resolve(r,"withoutCoords"):"noObjects"===a&&e.resolve(r,"noObjects")},function(t){e.resolve(t,"error")}),e.promise()},getFullListOflngLats:function(t){var e=(this.options.step,this.options.crs,this.getBboxOfPointsArray(t)),i=[];i.push(L.Projection.Mercator.project(new L.LatLng(e[0],e[1]))),i.push(L.Projection.Mercator.project(new L.LatLng(e[2],e[3])));var a=[],r=[],n=[],o=i[0].x,s=i[0].y;do{a.push(o),o+=this.options.step}while(o<i[1].x);do{r.push(s),s+=this.options.step}while(s<i[1].y);for(var l=0;l<a.length;l++)for(var d=0;d<r.length;d++)n.push([a[l],r[d]]);return n},getBboxOfPointsArray:function(t){var e=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];return t.reduce(function(t,e){return[Math.min(e[0],t[0]),Math.min(e[1],t[1]),Math.max(e[0],t[2]),Math.max(e[1],t[3])]},e)},getArrayofPointsInsideGeometry:function(t){for(var e=this.getFullListOflngLats(t),i=[],a=0;a<e.length;a++){this.checkLngLatString([L.Projection.Mercator.unproject(new L.Point(e[a][0],e[a][1])).lat,L.Projection.Mercator.unproject(new L.Point(e[a][0],e[a][1])).lng],t)===!0&&i.push([L.Projection.Mercator.unproject(new L.Point(e[a][0],e[a][1])).lat,L.Projection.Mercator.unproject(new L.Point(e[a][0],e[a][1])).lng])}return i},checkLngLatString:function(t,e){for(var i=t[0],a=t[1],r=!1,n=0,o=e.length-1;n<e.length;o=n++){var s=e[n][0],l=e[n][1],d=e[o][0],h=e[o][1];l>a!=h>a&&i<(d-s)*(a-l)/(h-l)+s&&(r=!r)}return r}},TDMap.Utils.SpatialFilterPolygon=L.Polygon.extend({options:{className:"leaflet-interactive spatial-filter-polygon"}}),TDMap.Utils.SpatialFilterCircle=L.Circle.extend({options:{className:"leaflet-interactive spatial-filter-cirlce"}}),L.Editable.PathEditor.prototype.onVertexMarkerAddEvent=function(t){this.fireAndForward("editable:vertex:add",t)},TDMap.Utils.SpatialFilterVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon spatial-filter-edge"},onAdd:function(t){L.Editable.VertexMarker.prototype.onAdd.call(this,t),this.onAddEvent()},onAddEvent:function(){this.editor.onVertexMarkerAddEvent(this)}}),TDMap.Utils.SpatialFilterMiddleVertex=L.Editable.MiddleMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon spatial-filter-middleEdge"}}),TDMap.Utils.SpatialFilter=L.Editable.extend({options:{vertexMarkerClass:TDMap.Utils.SpatialFilterVertex,polygonClass:TDMap.Utils.SpatialFilterPolygon,middleMarkerClass:TDMap.Utils.SpatialFilterMiddleVertex,circleClass:TDMap.Utils.SpatialFilterCircle,lineGuideOptions:{className:"measurment-lineguide"}},initialize:function(t,e){L.Editable.prototype.initialize.call(this,t),L.setOptions(this,e),this.map=t,this.map.spatialFilter=this,t.on("spatialfilter:stop",function(){this.abortDrawing(),this.featuresLayer.remove()},this)},disableMapZoom:function(){this.map.doubleClickZoom.disable(),this.map.touchZoom.disable()},enableMapZoom:function(){this.map.doubleClickZoom.enable(),this.map.touchZoom.enable()},enableMapZoomWhile:function(){var t=this;setTimeout(function(){t.map.doubleClickZoom.enable(),t.map.touchZoom.enable()},10)},abortDrawing:function(){this.off("editable:drawing:end",this.enableMapZoomWhile),this.off("editable:drawing:end",this.drawingPolygonEnd),this.off("editable:vertex:dragend",this.drawingPolygonEnd),this.off("editable:drawing:end",this.drawingCircleEnd),this.off("editable:vertex:dragend",this.drawingCircleEnd),this.enableMapZoom(),this.stopDrawing(),this.featuresLayer.remove(),this.removeLabel()},startPolygonSpatialFilter:function(){this.on("editable:drawing:end",this.drawingPolygonEnd),this.on("editable:vertex:dragend",this.drawingPolygonEnd),this.on("editable:vertex:deleted",this.drawingPolygonEnd),this.on("editable:vertex:add",this.drawingPolygonEnd),this.on("editable:drawing:start",this.disableMapZoom,this),this.on("editable:drawing:end",this.enableMapZoomWhile,this),L.Editable.prototype.startPolygon.call(this)},startCircleSpatialFilter:function(){this.on("editable:drawing:start",this.disableMapZoom,this),this.on("editable:drawing:end",this.drawingCircleEnd),this.on("editable:vertex:dragend",this.drawingCircleEnd),this.on("editable:vertex:drag",this.shawRadius),this.on("editable:drawing:end",this.enableMapZoomWhile,this),this.map.on("zoomend",this.shawRadius,this),L.Editable.prototype.startCircle.call(this)},drawingPolygonEnd:function(t){if(t.editor){var e=0;if(t.editor.editLayer.eachLayer(function(t){e++}),e<6)return}t.editTools.featuresLayer.eachLayer(function(t){t.bringToBack()});var i=this.featuresLayer._layers[this.featuresLayer._leaflet_id+1];i._map.fireEvent("spatialfilter:bounds",i.toGeoJSON().geometry.coordinates)},drawingCircleEnd:function(t){t.editTools.featuresLayer.eachLayer(function(t){t.bringToBack()});var e=t.editTools.featuresLayer._layers[t.editTools.featuresLayer._leaflet_id+1];e._map.fireEvent("spatialfilter:circle",{centerPoint:e._latlng,radius:e.getRadius()})},shawRadius:function(t){var e,i,a=t.editTools||this;a.editLayer.eachLayer(function(t){var a;t.eachLayer(function(t){a=t}),e=a.latlngs[0].distanceTo(a.latlngs[1]),i=a._icon._leaflet_pos}),a.createMouseMoveLabel(e,i)},createMouseMoveLabel:function(t,e){function i(e,i){e.each(function(){for(var e=d3.select(this),a=t.split("_"),r=!0,n=[],o=0,s=e.attr("x"),l=e.attr("y"),d=e.text(null).append("tspan").attr("x",s).attr("y",l).attr("dy","0em");r;)r=a.pop(),n.push(r),d.text(n.join(" ")),d.node().getComputedTextLength()>i&&(n.pop(),d.text(n.join("/")),n=[r],d=e.append("tspan").attr("x",s).attr("y",l).attr("dy",1.1*++o+0+"em").text(r))})}if(this.removeLabel(),void 0!==t){t=t<1e3?"Радиус: "+t.toFixed(0)+" м":"Радиус: "+(t/1e3).toFixed(1)+" км";var a,r=d3.select(".leaflet-overlay-pane").select("svg").append("g").attr("class","spatial-filter"),n=r.append("rect"),o=r.append("text").attr("x",e.x+25).attr("y",e.y-15).attr("class","spatial-filter-label-text").call(i,180);if(null!==o.node()){a=o.node().getBBox();var s=a.width+6,l=a.height+2;n.attr("class","spatial-filter-label-rectangle").attr("width",s+5).attr("height",l).attr("x",a.x-5).attr("y",a.y-1).style("fill","white").style("fill-opacity",.5).style("stroke","#3f51b5").style("stroke-width","1px").style("stroke-opacity",1)}}},removeLabel:function(){var t=$(".spatial-filter");t&&t.remove()}});